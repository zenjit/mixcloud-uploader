<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Mixcloud Upload Tool</title>
<style>
html, body { margin:0; padding:0; height:100%; overflow:hidden; font-family: system-ui, sans-serif; }

/* --- Psychedelic gradient background --- */
body {
  background: linear-gradient(270deg, #ff3cac, #784ba0, #2b86c5, #ff9a3c, #f9ff3c);
  background-size: 1500% 1500%;
  animation: rainbowGradient 30s ease infinite;
  display:flex; justify-content:center; align-items:center;
}
@keyframes rainbowGradient {0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}

body::before {
  content:"";
  position:absolute; top:0; left:0; width:100%; height:100%;
  background: radial-gradient(circle, rgba(255,255,255,0.05) 2px, transparent 2px);
  background-size:50px 50px;
  animation:ripple 12s linear infinite;
  pointer-events:none; z-index:0;
}
@keyframes ripple {0%{transform:translate(0,0) scale(1);}50%{transform:translate(25px,25px) scale(1.03);}100%{transform:translate(0,0) scale(1);}}

canvas#sparkleCanvas {position:absolute; top:0; left:0; width:100%; height:100%; z-index:0; pointer-events:none;}

/* --- Form container --- */
#form-container {
  position:relative; z-index:1;
  background: rgba(255,255,255,0.95);
  padding: 2rem; border-radius:16px;
  max-width:700px; width:90%;
  box-shadow:0 0 30px rgba(0,0,0,0.3);
}

h1 { font-size:2rem; margin-bottom:1rem; text-align:center; color:#222; text-shadow:0 0 8px #fff,0 0 12px #ff3cac,0 0 20px #784ba0; }

label { display:block; margin-top:1rem; font-weight:bold; color:#222; }
input, button { font-size:1rem; padding:0.5rem; width:100%; box-sizing:border-box; margin-top:0.3rem; border-radius:6px; border:1px solid #ccc; }
input:focus { outline:none; border-color:#ff3cac; box-shadow:0 0 12px #ff3cac66,0 0 20px #784ba099; }
button { width:auto; background:linear-gradient(45deg,#ff3cac,#784ba0,#2b86c5); color:white; border:none; cursor:pointer; margin-top:1.5rem; transition: transform 0.2s; }
button:hover { transform:scale(1.05); background:linear-gradient(45deg,#784ba0,#2b86c5,#ff9a3c); }

#tag-container { display:flex; flex-wrap:wrap; gap:0.4rem; margin-top:0.5rem; }
.tag-chip { display:inline-flex; align-items:center; background:#784ba0; color:white; padding:0.2rem 0.6rem; border-radius:999px; cursor:pointer; font-size:0.9rem; }
.tag-chip span { margin-left:0.4rem; font-weight:bold; color:#eee; }
.success { color:green; margin-top:1rem; } .error { color:red; margin-top:1rem; }
.tag-suggestions { border:1px solid #ccc; background:white; position:absolute; max-height:150px; overflow-y:auto; width:calc(100% - 1rem); z-index:1000; }
.tag-suggestions div { padding:0.4rem; cursor:pointer; }
.tag-suggestions div:hover { background:#ff3cac; color:white; }
</style>
</head>
<body>
<canvas id="sparkleCanvas"></canvas>

<div id="form-container">
  <h1>Mixcloud Upload Tool</h1>
  <form id="upload-form">
    <label>MP3 File</label>
    <input type="file" id="file" name="file" accept=".mp3" required />

    <label>Show Title</label>
    <input type="text" id="title" name="title" required />

    <label>Host</label>
    <input type="text" id="host" name="host" />

    <label>Date</label>
    <div style="display:flex; gap:0.5rem;">
      <input type="number" id="day" name="day" placeholder="DD" min="1" max="31" style="width:80px;">
      <input type="number" id="month" name="month" placeholder="MM" min="1" max="12" style="width:80px;">
      <input type="number" id="year" name="year" placeholder="YY" min="20" max="30" style="width:80px;">
    </div>

    <label>Tags</label>
    <div style="position:relative;">
      <input type="text" id="tag-input" placeholder="Type tag and press Enter" autocomplete="off" />
      <div id="tag-suggestions" class="tag-suggestions" style="display:none;"></div>
    </div>
    <div id="tag-container"></div>

    <button type="submit">Upload to Mixcloud</button>
    <div id="status"></div>
  </form>
</div>

<script>
// ---------- Optimized Sparkles ----------
const canvas = document.getElementById('sparkleCanvas');
const ctx = canvas.getContext('2d');
let w,h;
function resize(){ w=canvas.width=window.innerWidth; h=canvas.height=window.innerHeight; }
window.addEventListener('resize',resize); resize();

const sparkleImg = document.createElement('canvas');
const spCtx = sparkleImg.getContext('2d');
sparkleImg.width=sparkleImg.height=6;
spCtx.fillStyle='white'; spCtx.beginPath(); spCtx.arc(3,3,3,0,Math.PI*2); spCtx.fill();

class Particle{ constructor(){ this.reset(); }
reset(){ this.x=Math.random()*w; this.y=Math.random()*h; this.vx=(Math.random()-0.5)*0.4; this.vy=(Math.random()-0.5)*0.4; this.alpha=Math.random()*0.6+0.4; this.size=Math.random()*2+1; }
update(){ this.x+=this.vx; this.y+=this.vy; if(this.x<0||this.x>w||this.y<0||this.y>h)this.reset(); }
draw(){ ctx.globalAlpha=this.alpha; ctx.drawImage(sparkleImg,this.x,this.y,this.size*3,this.size*3); ctx.globalAlpha=1; }
}
const particles=[]; for(let i=0;i<50;i++)particles.push(new Particle());
let then=0;
function animate(now){ requestAnimationFrame(animate); if(now-then<33)return; then=now; ctx.clearRect(0,0,w,h); particles.forEach(p=>{p.update();p.draw();}); }
animate();

// ---------- Form Handling ----------
const fileInput=document.getElementById("file");
const titleInput=document.getElementById("title");
const hostInput=document.getElementById("host");
const tagInput=document.getElementById("tag-input");
const tagContainer=document.getElementById("tag-container");
const tagSuggestionsDiv=document.getElementById("tag-suggestions");
const form=document.getElementById("upload-form");
const statusDiv=document.getElementById("status");

let currentTags=[]; let showsMetadata={}; let allTags=new Set();
let backendURL="";

// Detect backend URL dynamically
async function detectBackend(){
  try{
    let res = await fetch(`${window.location.origin}/shows_metadata`);
    if(res.ok) backendURL = window.location.origin;
    else backendURL = "https://your-backend-railway-url.up.railway.app";
  }catch(err){ backendURL = "https://your-backend-railway-url.up.railway.app"; }
}
await detectBackend();

// Load metadata
async function loadMetadata(){
  try{
    const res = await fetch(`${backendURL}/shows_metadata`);
    showsMetadata = await res.json();
    Object.values(showsMetadata).forEach(show => (show.tags||[]).forEach(tag => allTags.add(tag)));
  }catch(err){ console.error("Failed to load shows metadata:", err); }
}
loadMetadata();

// Handle file upload & auto-fill
fileInput.addEventListener("change",()=>{
  currentTags=[]; tagContainer.innerHTML=""; statusDiv.textContent="";

  const file=fileInput.files[0]; if(!file)return;
  const filename=file.name.replace(".mp3","");
  const dateMatch=filename.match(/(\d{1,2})[.\-_ ](\d{1,2})[.\-_ ](\d{2})/);

  if(dateMatch){
    document.getElementById("day").value=dateMatch[1];
    document.getElementById("month").value=dateMatch[2];
    document.getElementById("year").value=dateMatch[3];
  }else{
    document.getElementById("day").value="";
    document.getElementById("month").value="";
    document.getElementById("year").value="";
  }

  const cleanTitle = filename.replace(/(\d{1,2})[.\-_ ](\d{1,2})[.\-_ ](\d{2})/,"").trim();
  titleInput.value = cleanTitle;

  const possibleShow = Object.keys(showsMetadata).find(show => cleanTitle.toLowerCase().includes(show.toLowerCase()));
  if(possibleShow){
    const meta = showsMetadata[possibleShow];
    hostInput.value = meta.host || "";
    currentTags = [...(meta.tags||[])];
    renderTags();
  }
});

// --- Tags ---
tagInput.addEventListener("keydown", e=>{
  if(e.key==="Enter"){ e.preventDefault(); const tag=tagInput.value.trim();
  if(tag&&!currentTags
